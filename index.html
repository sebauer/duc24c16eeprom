<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title>Ducati 24C16 / I2K Dash Tool</title>
  </head>

  <body>
    <!--JavaScript at end of body for optimized loading-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {

        // Define Offsets
        const immoBypassOffset1 = 0x100;
        const immoBypassOffset2 = 0x110;

        const keyCode1Offset = 0x120;
        const keyCode2Offset = 0x130;

        const checksumBytesOffset = 0x14;

        const mileageOffset = 0x10;
        const mileageChecksumOffset = 0x19;
        const mileage2Offset = 0x20;
        const mileage2ChecksumOffset = 0x29;

        // Elements
        const fileInput = document.getElementById('eepromFileSelector');
        const mileageInput = document.getElementById('mileageInput');
        const mileageDisplay = document.getElementById('mileageDisplay');
        const checksumDisplay = document.getElementById('checksumDisplay');
        const newChecksumDisplay = document.getElementById('checksumNew');
        const immoBypass1Display = document.getElementById('immoBypass1Display');
        const immoBypass2Display = document.getElementById('immoBypass2Display');
        const keyCode1Display = document.getElementById('keyCode1Display');
        const keyCode2Display = document.getElementById('keyCode2Display');
        const downloadButton = document.getElementById('downloadButton');
        const startDownloadButton = document.getElementById('startDownloadButton');
        const checksumMismatchIcon = document.getElementById('checksumMismatchIcon');

        let checksumByte1;
        let checksumByte2;

        let tooltips = M.Tooltip.init(document.querySelectorAll('.tooltipped'));
        let modals = M.Modal.init(document.querySelectorAll('.modal'));

        function integerToBytes(integerValue) {
          const buffer = new ArrayBuffer(4);
          const byteDataView = new DataView(buffer);

          byteDataView.setInt32(0, integerValue, true);

          const byteArray = [];
          for(let i = 0; i < 4; i++) {
            byteArray.push(byteDataView.getUint8(i));
          }
          return byteArray;
        }

        function calculateOdometerChecksum(newOdometerValue, checkByte1, checkByte2) {

          const odometerBuffer = new ArrayBuffer(4);
          const odometerDataView = new DataView(odometerBuffer);
          const adjustedOdometerValue = newOdometerValue*10;

          // Create byte array for everything that goes into the checksum
          odometerDataView.setInt32(0, adjustedOdometerValue, true);

          const byteArray = integerToBytes(adjustedOdometerValue);

          // Add additional bytes part of the checksum calculation
          byteArray.push(checkByte1);
          byteArray.push(checkByte2);
          byteArray.push(0x0);
          byteArray.push(0x0);

          // Byte Shifting
          let byteShiftedSum = 0;
          for(let i = 0; i < byteArray.length; i++) {
            const currentByte = byteArray[i];
            const calculatedValue = currentByte + (currentByte >> 1);
            byteShiftedSum += calculatedValue;
          }

          // Mod
          const checksum = byteShiftedSum & 0xFF;
          return checksum;
        }

        function readableChecksum(checksum){
          return checksum.toString(16).padStart(2, '0').toUpperCase();
        }

        function readKeyCode(dataView, offset) {
          const keyCodeInHex = [];

          for (let i = 0; i < 10; i++) {
              const currentByte = dataView.getUint8(offset + i);
              const hexString = currentByte.toString(16).padStart(2, '0').toUpperCase();
              keyCodeInHex.push(hexString);
            }

            return keyCodeInHex.join(' ');
        }

        function readImmoCode(dataView, offset) {
          const immoBypass = dataView.getUint8(offset) + ' '
              + dataView.getUint8(offset+1) + ' '
              + dataView.getUint8(offset+2) + ' '
              + dataView.getUint8(offset+3) + ' '
              + dataView.getUint8(offset+4);
          return immoBypass;
        }

        function readOdometer(dataView) {
          return dataView.getInt32(mileageOffset, true)/10;
        }

        function readOdometerChecksum(dataView) {
          return readableChecksum(dataView.getUint8(mileageChecksumOffset));
        }

        function downloadDump(dataBuffer, filename) {
          const blob = new Blob([dataBuffer], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(blob);
          window.location.href = url;

          window.URL.revokeObjectURL(url);
        }

        function createModifiedDump(newOdometerInput) {
          const normalizedOdometerValue = newOdometerInput*10;
          const file = fileInput.files[0];

          if(!file)
            return;

          if(!file.name.toLowerCase().endsWith('.bin')) {
            M.toast({
              html: 'Please select a .bin file.',
              classes: 'red darken-1'
            });

            fileInput.value = '';
            return;
          }

          const reader = new FileReader();

          reader.onload = function(e) {
            const modifiedBuffer = e.target.result;
            const modifiedDataView = new DataView(modifiedBuffer);


            const newChecksum = calculateOdometerChecksum(newOdometerInput, checksumByte1, checksumByte2);
            // Write odometer values
            modifiedDataView.setUint32(mileageOffset, normalizedOdometerValue, true);
            modifiedDataView.setUint32(mileage2Offset, normalizedOdometerValue, true);
            // Write checksums
            modifiedDataView.setUint8(mileageChecksumOffset, newChecksum);
            modifiedDataView.setUint8(mileage2ChecksumOffset, newChecksum);

            downloadDump(modifiedBuffer, 'modified.bin');
          };

          reader.readAsArrayBuffer(file);
        }

        fileInput.addEventListener('change', (event) => {
          const file = event.target.files[0];
          mileageInput.value = '';
          newChecksumDisplay.value = '';
          mileageInput.disabled = true;
          downloadButton.disabled = true;
          checksumMismatchIcon.classList.add('hide');

          // File validations
          if(!file)
            return;

          if(file.size !== 2048) {
            M.toast({
              html: 'Unexpected file size. A 24C16 dump with a size of 2048 Bytes is expected.',
              classes: 'red darken-1'
            });

            fileInput.value = '';
            return;
          }

          if(!file.name.toLowerCase().endsWith('.bin')) {
            M.toast({
              html: 'Please select a .bin file.',
              classes: 'red darken-1'
            });

            fileInput.value = '';
            return;
          }

          mileageInput.disabled = false;

          const reader = new FileReader();

          reader.onload = function(e) {
            const buffer = e.target.result;
            const dataView = new DataView(buffer);

            // Get Readigns
            const keyCode1 = readKeyCode(dataView, keyCode1Offset);
            const keyCode2 = readKeyCode(dataView, keyCode2Offset);

            const mileage = readOdometer(dataView);
            const mileageChecksum = readOdometerChecksum(dataView);

            const immoBypass1 = readImmoCode(dataView, immoBypassOffset1);
            const immoBypass2 = readImmoCode(dataView, immoBypassOffset2);

            checksumByte1 = dataView.getUint8(checksumBytesOffset);
            checksumByte2 = dataView.getUint8(checksumBytesOffset+1);

            // Display Values
            mileageDisplay.textContent = mileage + ' kms';
            checksumDisplay.textContent = mileageChecksum;

            const calculatedChecksum = readableChecksum(calculateOdometerChecksum(mileage, checksumByte1, checksumByte2));
            if(calculatedChecksum !== mileageChecksum) {
              console.log('Checksum mismatch %s %s', calculatedChecksum, mileageChecksum);
              checksumMismatchIcon.classList.remove('hide');
            }

            immoBypass1Display.textContent = immoBypass1;
            immoBypass2Display.textContent = immoBypass2;

            keyCode1Display.innerText = keyCode1;
            keyCode2Display.innerText = keyCode2;

          };

          reader.readAsArrayBuffer(file);

        });

        mileageInput.addEventListener('change', (event) => {
          const newMileageValue = event.target.value;

          if(newMileageValue == '') {
            newChecksumDisplay.value = '';
            return;
          }

          newChecksumDisplay.value = readableChecksum(calculateOdometerChecksum(newMileageValue, checksumByte1, checksumByte2));
          downloadButton.classList.remove('disabled');
        });

        startDownloadButton.addEventListener('click', (event) => {
          createModifiedDump(mileageInput.value);
        });
      });
    </script>

    <div class="section no-pad-bot red darken-4 white-text">
      <h1 class="header center">Ducati Dash Tool</h1>
      <h5 class="center">For 24C16/I2K</h5>
      <br/>
    </div>

    <div class="container">
      <div class="divider"></div>

      <div class="section">
        <div class="row">
          <div class="col s12 center-align grey-text text-lighten-1 light">
            This tool is used to read and process data from Ducati dashboards equipped with a 24C16 EEPROM and I2K immobilizer chip. It enables you to display and edit the odometer reading, recover immo bypass codes, and access the key codes of the programmed keys.
          </div>
        </div>
      </div>

      <div class="divider"></div>
      
      <div class="section">
        <!-- File Selector -->
        <div class="row">
          <div class="col s8 offset-s2">

            <form action="#">
              <div class="file-field input-field">
                <div class="btn red darken-4">
                  <i class="material-icons left">file_upload</i>
                  <span>Open Dump</span>
                  <input type="file" accept=".bin" id="eepromFileSelector">
                </div>
                <div class="file-path-wrapper">
                  <input class="file-path validate" type="text" id="eepromFileSelectorWrapper" placeholder="EEPROM Dump, .BIN 2048 Bytes">
                </div>
              </div>
            </form>

          </div>
        </div>
        <div class="divider"></div>

        <!-- Display of mileage values -->
        <div class="container">
          <div class="row">
            <div class="col s12 center-align">
              <h5>Odometer Reading</h5>
            </div>
          </div>
          <div class="row">
            <div class="col s6 right-align">
              Odometer Reading
            </div>
            <div class="col s6" id="mileageDisplay">
              -
            </div>
          </div>
          <div class="row">
            <div class="col s6 right-align">
              Odometer Checksum
            </div>
            <div class="col s6 left-align">
              <span id="checksumDisplay">-</span> <i class="material-icons red-text text-darken-1 hide tooltipped" style="display: inline-flex; vertical-align: -6px;" data-position="right" data-tooltip="Checksum validation failed" id="checksumMismatchIcon">error</i>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Display of immobilizer related values -->
        <div class="container">
          <div class="row">
            <div class="col s12 center-align">
            <h5>Immobilizer</h5>
            </div>
          </div>
          <div class="row">
            <div class="col s6 right-align">
              Immo Bypass Code 1
            </div>
            <div class="col s6" id="immoBypass1Display">
              -
            </div>
          </div>
          <div class="row">
            <div class="col s6 right-align">
              Immo Bypass Code 2
            </div>
            <div class="col s6" id="immoBypass2Display">
              -
            </div>
          </div>
          <div class="row">
            <div class="col s6 right-align">
              Key Code 1
            </div>
            <div class="col s6" id="keyCode1Display">
              -
            </div>
          </div>
          <div class="row">
            <div class="col s6 right-align">
              Key Code 2
            </div>
            <div class="col s6" id="keyCode2Display">
              -
            </div>
          </div>
        </div>
        
        <div class="divider"></div>

        <!-- Editing of mileage values -->
        <div class="container">
          <div class="row">
            <div class="col s12 center-align">
              <h5>Odometer Adjustment</h5>
            </div>
          </div>
          <div class="row">
            <div class="col s6 input-field">
              <input id="mileageInput" type="number" class="validate" placeholder="123456" min="0" step="0.1" disabled>
              <label for="mileageInput">New Odometer Value</label>
            </div>
            <div class="col s6 input-field">
              <input id="checksumNew" type="text" placeholder="xx" disabled>
              <label for="checksumNew">New Odometer Checksum</label>
            </div>
          </div>
          <div class="row">
            <div class="col s12 center-align">
              <a class="waves-effect waves-light btn red darken-4 disabled modal-trigger" href="#downloadModal" id="downloadButton"><i class="material-icons left">save</i>Save modified File</a>
              <div id="downloadModal" class="modal">
                <div class="modal-content">
                  <h4>Important Notice</h4>
                  <p>Messing with the odometer can get you into legal hot water, depending on where you live. On top of that, the checksums might be off and the dump could be totally borked. If you decide to flash this thing, that’s on you – use at your own risk.</p>
                </div>
                <div class="modal-footer">
                  <a href="#!" class="modal-close waves-effect waves-green btn-flat grey lighten-2">Disagree</a>
                  <a href="#!" class="modal-close waves-effect waves-green btn-flat amber darken-2 white-text" id="startDownloadButton">I understand the risks, continue</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

      </div>
    </div>
    
    <footer class="page-footer red darken-4">
      <div class="footer-copyright">
        <div class="container">
          Made by <a class="red-text text-lighten-3" href="https://github.com/sebauer">github.com/sebauer</a> | Visit <a class="red-text text-lighten-3" href="https://github.com/sebauer/duc24c16eeprom">GitHub Project Page</a>
        </div>
      </div>
    </footer>
  </body>
</html>